# 欢迎使用
![图标]()

界面友好，功能完善，可拓展的即时通讯客户端。

## 特色

### 灵活
贴合您的使用需求，打破信息来源隔阂，随心所欲对会话及内容进行二次筛选，归类，编组。让聊天回归纯粹。
### 个性
界面设计遵循 Google 推出的全新设计语言 —— Material You。主题根据壁纸颜色生成（仅限 Android 12），内置多种颜色主题可供选择，只为你设计。

对多种屏幕尺寸进行布局适配（手机，可折叠设备，平板），支持深色模式。
### 同步
利用系统级推送，在不同设备之间组建消息同步网络。轻松转移消息接收成本，极大节省后台开销。
### 插件化
第三方插件提供更丰富，更稳定的消息源。用户可根据使用习惯自行组件消息来源库，不同来源的消息仍可以得到统一而高效的处理。
### 遵循最佳实践
使用现代安卓开发方式。界面完全使用原生 Android 界面的新工具包 Jetpack Compose 构建。在持久化，导航，后台调度，架构等诸多方面采用 Jetpack 库（包括但不限于`Paging 3` ， `DataStore` , `Navigation` , `WorkManager` , `Room`）。

## 功能

### 消息收发
支持常见消息类型的接收与发送。具体行为受插件控制。

客户端支持的消息类型及行为包括：

|消息类型|接收|发送|
|-|-|-|
|文本|✓|✓|
|图片（jpg，png，gif）|✓|✓|
|语音|✓|✓|
|文件|✓|✕|
|引用回复|✓|✓|
|@某人|✓|✓|

>对于**表情**，推荐转化为emoji或文字描述，以文本形式接收/发送
>
>更多类型与行为将通过版本更新陆续支持

### 会话编组
Parabox 为你带来全新的会话管理方式！告别混乱的多平台会话和重复的通知，全新的编组功能允许用户将**不同平台**的**不同会话**编组至新会话中，且不存在任何额外开销。编组后的会话享有与普通会话一致的功能体验。

这一功能使人振奋：您可以抛弃数目繁多而功能相似的工作群组了——您只需要保留一个。

### 文件管理
您是否曾遇到难以下载历史文件的窘境？散乱在各处的文件不仅类型繁多，而且难以追溯与定位。

Parabox 贴心地为您准备了独立的文件管理页面。提供**时间**，**类型**，**文件大小**等多种筛选条件。配合关键字检索，助你快速定位文件，展开工作流。

### 云端备份

Parabox 可便利地接入您喜欢的云端存储服务。在后台闲暇及网络条件允许时自动备份文件至云端，不占用本地存储空间。从此会话文件**不易错过，不再丢失**。

### 通知进化

通知进化功能得益于 Android 不断进步的通知标准，使得通知功能更规范，更实用。适配的系统特性包括：

- 通知渠道
- 展开通知
- 快捷回复
- 对话泡

### 系统级推送*
通过 FCM 消息，Parabox可**停止后台服务驻留**，同时正常接收消息。系统级推送服务接受系统统一调度，拥有更出色的调度机制和更佳的性能。这将极大节省系统资源，延长设备续航。

> *该功能尚不稳定。受限于信息源接入方式，并未根本减少消息接收成本，仅为成本转嫁。

### 插件化信息源
第三方插件提供更丰富，更稳定的消息源。用户可根据使用习惯自行组件消息来源库，不同来源的消息仍可以得到统一而高效的处理。

针对插件开发，同时提供开发者工具包与配套文档，内含预定义类和工具方法。助力开发者忽略对接细节，专注功能开发。可跳转阅读开发文档。

### 数据导出
Parabox 提供数据导出功能，用户可将会话数据导出至本地存储，以便在其他设备上使用，或作备份之用。同时，用户可将会话数据导出至其他应用，如云端存储。

## 如何工作
> 该部分涉及较为复杂的工作原理。一般使用者可跳转阅读快速开始。

### 跨进程通信

Parabox 运行依靠**客户端**与**插件**配合运行。单独一方运行无法发挥作用。

客户端与插件分别运行在不同进程中。不同进程间依靠Messenger进行通信。插件扮演服务端，主端扮演客户端，客户端可同时连接多个插件。一般情况下，客户端启动时，Parabox依次执行以下操作：

1. 使用IntentFilter筛选出符合规范的插件，将其添加至临时插件列表。
2. 依次对列表中插件进行bindService操作。
3. 对于连接成功的插件，客户端发送一条初始化请求。插件根据请求，结合当前运行状态启进行初始化（如启动服务）。
4. 插件每次发生状态变更(启动、停止、暂停、恢复等)，都会向客户端发送一条通知。客户端根据通知内容，更新插件状态显示。该状态监听将持续整个运行周期。
5. 当插件返回状态为运行中时，客户端将其视作稳定连接。启用当前插件的消息发送出口。同时监听消息接收入口，接收来自插件的消息。

以上过程都已被封装成可方便调用的方法，开发者无需关心其中细节。

>特别地，对于接收到的每一条 **请求（REQUEST）** ，都要求使用时间戳回送验证。超时未返回的请求将被视为无效，并返回超时错误。
>
> **通知（NOTIFICATION）** 则不需要回送验证，但仍要求使用时间戳。
>
>开发工具包中所有封装方法，包括消息发送/接收，状态更新，设置项更新等，都使用以上两种方式进行通信。

### 待接收消息缓存机制

由于连接不畅，客户端服务被杀死等特殊原因，可能会导致消息丢失。为避免这种情况，Parabox 提供了待接收消息缓存机制。

每一条消息在内部使用 **请求（REQUEST）** 方式进行通信。插件维护一个待接收消息缓存队列。插件从队列中取出所有消息，并尝试向客户端发送，若消息被客户端成功接收并成功存入，客户端会向插件发送一条确认回送验证，反之则发送携带错误码的回送验证。若插件收到确认回送验证，则当前传输成功，将其从队列移除；若接收到错误或触发超时错误，则将消息重新加入待接收消息缓存队列，等待下一次发送。若多次收到错误，则判断客户端断联，暂停以上循环，直至客户端重新连接并触发刷新。

若插件服务被杀死，则该缓存机制失效，消息将丢失。

以上过程都已被封装成可方便调用的方法，开发者无需关心其中细节。

### FCM

由于跨进程通信方法的固有缺陷，插件与客户端需同时保持服务运行，以保证通信畅通。（插件服务用作消息接收，客户端服务用作通知推送和数据库插入）

通过 FCM ，用户可先选择将以上服务运行于其他设备（如备用机），再将消息包通过FCM传输至主力机。由于FCM消息接收由系统维护，主力机上不再需要额外运行任何后台服务，从而实现消息接收成本转嫁。

### 数据存储

Parabox 主要维护四类数据：**会话（Contact）、消息（Message）、文件（File），连接（PluginConnection）**。每类数据都具有单独的专属id，由插件提供。在实际存储中，通常还附加上插件id，以区分不同插件的数据。每种类型也具有普通类型（Model）与实体类型（Entity）。

|数据类型|内容|备注|
|-|-|-|
|会话（Contact）|联系人的抽象（不区分群组与私聊），包含名称，头像等账户信息和各种配置信息|与连接多对多绑定|
|消息（Message）|消息的抽象，包含消息内容，发送者账户信息|与连接一对一绑定|
|文件（File）|文件的抽象，包含文件名，文件大小，文件类型，下载/备份方式等信息|与消息一对一绑定|
|连接（PluginConnection）|插件与客户端的连接信息，主要包含发送消息时所需的连接数据。也用作判断会话类型|与会话多对多绑定|

更多实现细节，请跳转阅读开发者文档。

## 开发

Parabox 的插件生态需要开源社区共同维护。我们期待您的加入。

要快速入门插件开发，请跳转阅读开发者文档。

## 支持本项目
